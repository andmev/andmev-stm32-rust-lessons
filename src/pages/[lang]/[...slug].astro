---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getAvailableLanguages } from '@/utils/languages';
import { withBase } from '@/utils/url';
import { validateLanguage } from '@/utils/validators';
import { getLessons } from '@/utils/collections';
import { render } from 'astro:content';

export async function getStaticPaths() {
  const languages = await getAvailableLanguages();
  const allLessons = await getLessons();

  return languages.flatMap((lang) => {
    // Filter and sort lessons for this language (in memory, single operation)
    const langLessons = allLessons
      .filter((lesson) => lesson.id.startsWith(`${lang}/lessons/`))
      .sort((a, b) => a.data.order - b.data.order);

    // Map lessons to include slugs
    const lessonsWithSlugs = langLessons.map((lesson) => {
      const defaultSlug = lesson.id.replace(`${lang}/lessons/`, '').replace('.mdx', '');
      const slug = lesson.data.url || defaultSlug;
      return { ...lesson, slug };
    });

    // Generate paths with prev/next navigation calculated from array indices
    return lessonsWithSlugs.map((lesson, index) => ({
      params: { lang, slug: lesson.slug },
      props: {
        lesson,
        prevLesson:
          index > 0
            ? {
                title: lessonsWithSlugs[index - 1].data.title,
                slug: lessonsWithSlugs[index - 1].slug,
              }
            : null,
        nextLesson:
          index < lessonsWithSlugs.length - 1
            ? {
                title: lessonsWithSlugs[index + 1].data.title,
                slug: lessonsWithSlugs[index + 1].slug,
              }
            : null,
      },
    }));
  });
}

const { lang } = Astro.params;

// Validate language parameter for type safety
if (!lang || !validateLanguage(lang)) {
  return Astro.redirect('/404');
}

const { lesson, prevLesson, nextLesson } = Astro.props;
const { Content } = await render(lesson);
---

<BaseLayout
  title={lesson.data.title}
  lang={lang}
  description={lesson.data.description}
  ogTitle={lesson.data.ogTitle}
  ogDescription={lesson.data.ogDescription}
  ogImage={lesson.data.ogImage}
  ogType={lesson.data.ogType}
  twitterCard={lesson.data.twitterCard}
  canonicalUrl={lesson.data.canonicalUrl}
>
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'LearningResource',
      name: lesson.data.title,
      description: lesson.data.description,
      inLanguage: lang,
      learningResourceType: 'Tutorial',
      educationalLevel: 'Intermediate',
      audience: {
        '@type': 'EducationalAudience',
        educationalRole: 'student',
      },
    })}
  />

  <article class="mx-auto w-full max-w-[78rem] px-4 pt-16 pb-20 sm:px-6 md:pt-24 md:pb-28">
    <header class="mx-auto w-full max-w-[54rem] text-center">
      <h1
        class="mx-auto max-w-[24ch] font-serif [font-size:clamp(2.6rem,3.1vw+1.4rem,4.1rem)] leading-[1.08] tracking-[-0.02em] [text-wrap:balance]"
      >
        {lesson.data.title}
      </h1>

      <p
        class="font-sans-narrow text-muted mx-auto mt-5 max-w-[52ch] [font-size:clamp(1.06rem,0.55vw+0.96rem,1.35rem)] leading-[1.65] [text-wrap:pretty]"
      >
        {lesson.data.description}
      </p>
    </header>

    <div class="mx-auto mt-12 w-full max-w-[min(82vw,68rem)]">
      <div class="lesson-prose">
        <Content />
      </div>
    </div>

    {
      (prevLesson || nextLesson) && (
        <nav class="lesson-bottom-nav" aria-label="Lesson navigation">
          {prevLesson ? (
            <a
              class="lesson-nav-card"
              href={withBase(`/${lang}/${prevLesson.slug}/`)}
              aria-label={`Previous lesson: ${prevLesson.title}`}
            >
              <span class="lesson-nav-direction">Previous</span>
              <span class="lesson-nav-title">{prevLesson.title}</span>
            </a>
          ) : (
            <span class="lesson-nav-spacer" aria-hidden="true" />
          )}

          {nextLesson ? (
            <a
              class="lesson-nav-card lesson-nav-card--next"
              href={withBase(`/${lang}/${nextLesson.slug}/`)}
              aria-label={`Next lesson: ${nextLesson.title}`}
            >
              <span class="lesson-nav-direction">Next</span>
              <span class="lesson-nav-title">{nextLesson.title}</span>
            </a>
          ) : (
            <span class="lesson-nav-spacer" aria-hidden="true" />
          )}
        </nav>
      )
    }
  </article>
</BaseLayout>
